- job:
    name: 'ovirt_master_publish-rpms_nightly'
    description: >
      Collects RPMs from all oVirt projects (master branches) and publish them
      to resources.ovirt.org yum repository.<br>
      This job is automatically updated by jenkins job builder, any manual
      change will be lost in the next update. If you want to make permanent
      changes, check out the <a href="http://gerrit.ovirt.org/gitweb?p=jenkins.git;a=tree;h=refs/heads/master;hb=refs/heads/master">
      jenkins</a> repo.
    properties:
      - throttle:
          enabled: false
          max-per-node: 1
          max-total: 3
          option: project
      - build-discarder:
          num-to-keep: 10
    node: master
    triggers:
      - timed: "H(20-40) 0 * * *"
    wrappers:
      - workspace-cleanup
      - timeout:
          timeout: 900
          type: absolute
          write-description: 'Timed out'
          fail: true
      - timestamps
    builders:
      - shell: |
          rm -rf $WORKSPACE/artifacts
          mkdir $WORKSPACE/artifacts


      - copy-create-job-artifact-all_master-platforms:
          project-prefix: ovirt-host-deploy_master_build-artifacts-
          project-suffix: ''
      - copy-create-job-artifact-all_master-platforms:
          project-prefix: otopi_master_build-artifacts-
          project-suffix: ''
      - copy-create-job-artifact-all_master-platforms:
          project-prefix: ovirt-vmconsole_master_build-artifacts-
          project-suffix: ''
      - copy-create-job-artifact-all_master-platforms:
          project-prefix: ovirt-imageio_master_build-artifacts-
          project-suffix: ''
      - copy-create-job-artifact-engine_master-platforms:
          project-prefix: ovirt-iso-uploader_master_build-artifacts-
          project-suffix: ''
      - copy-create-job-artifact-engine_master-platforms:
          project-prefix: ovirt-log-collector_master_build-artifacts-
          project-suffix: ''
      - copy-create-job-artifact-engine_master-platforms:
          project-prefix: ovirt-engine-cli_master_build-artifacts-
          project-suffix: ''
      - copy-create-job-artifact-engine_master-platforms:
          project-prefix: ovirt-engine-extension-aaa-jdbc_master_build-artifacts-
          project-suffix: ''
      - copy-create-job-artifact-engine_master-platforms:
          project-prefix: ovirt-engine-extension-aaa-ldap_master_build-artifacts-
          project-suffix: ''
      - copy-create-job-artifact-engine_master-platforms:
          project-prefix: ovirt-engine-extension-aaa-misc_master_build-artifacts-
          project-suffix: ''
      - copy-create-job-artifact-engine_master-platforms:
          project-prefix: ovirt-engine-extension-logger-log4j_master_build-artifacts-
          project-suffix: ''
      - copy-create-job-artifact-engine_master-platforms:
          project-prefix: ovirt-dwh_master_build-artifacts-
          project-suffix: ""
      - copy-create-job-artifact-engine_master-platforms:
          project-prefix: ovirt-setup-lib_master_build-artifacts-
          project-suffix: ""
      - copy-create-job-artifact-engine_master-platforms:
          project-prefix: vdsm-jsonrpc-java_master_build-artifacts-
          project-suffix: ""
      - copy-create-job-artifact-engine_master-platforms:
          project-prefix: ovirt-engine-sdk_master_build-artifacts-
          project-suffix: ""
      - copy-create-job-artifact-engine_master-platforms:
          project-prefix: python-ovirt-engine-sdk4_master_build-artifacts-
          project-suffix: ""
      - copy-create-job-artifact-engine-master-ppc64le-platforms:
          project-prefix: python-ovirt-engine-sdk4_master_build-artifacts-
          project-suffix: ""
      - copy-create-job-artifact-engine_master-platforms:
          project-prefix: ovirt-engine-sdk-java_master_build-artifacts-
          project-suffix: ""
      - copy-create-job-artifact-engine_master-platforms:
          project-prefix: java-ovirt-engine-sdk4_master_build-artifacts-
          project-suffix: ""
      - copy-create-job-artifact-engine_master-platforms:
          project-prefix: ovirt-scheduler-proxy_master_build-artifacts-
      - copy-create-job-artifact-engine_master-platforms:
          project-prefix: ovirt-optimizer_master_build-artifacts-
          project-suffix: ""
      - copy-create-job-artifact-engine_master-platforms:
          project-prefix: ovirt-engine-dashboard_master_build-artifacts-
          project-suffix: ""

      - copy-create-job-artifact-vdsm-master-platforms:
          project-prefix: ioprocess_master_build-artifacts-
          project-suffix: ""
      - copy-create-job-artifact-vdsm-master-ppc64le-platforms:
          project-prefix: ioprocess_master_build-artifacts-
          project-suffix: ""
      - copy-create-job-artifact-vdsm-master-platforms:
          project-prefix: vdsm_master_build-artifacts-
          project-suffix: ""
      - copy-create-job-artifact-vdsm-master-ppc64le-platforms:
          project-prefix: vdsm_master_build-artifacts-
          project-suffix: ""

      - copy-create-job-artifact-hosted-engine-master-platforms:
          project-prefix: ovirt-hosted-engine-ha_master_build-artifacts-
          project-suffix: ""
      - copy-create-job-artifact-hosted-engine-master-platforms:
          project-prefix: ovirt-hosted-engine-setup_master_build-artifacts-
          project-suffix: ""

      - copy-create-job-artifact-engine_master-platforms:
          project-prefix: opstools-ansible_master_create-rpms-
          project-suffix: _merged

      - copy-create-job-artifact:
          project: unboundid-ldapsdk_master_create-rpms-el7-x86_64_merged
      - copy-create-job-artifact:
          project: ovirt-appliance_master_build-artifacts-el7-x86_64

      - copy-create-job-artifact-engine_master-platforms:
          project-prefix: ovirt-engine_master_build-artifacts-
          project-suffix: ""

      - copy-create-job-artifact-engine_master-platforms:
          project-prefix: ovirt-engine-wildfly-overlay10_master_create-rpms-
          project-suffix: _merged

      - copy-create-job-artifact-engine_master-platforms:
          project-prefix: ovirt-engine-wildfly10_master_create-rpms-
          project-suffix: _merged

      - copy-create-job-artifact-vdsm-master-platforms:
          project-prefix: mom_master_build-artifacts-
          project-suffix: ""

      - copy-create-job-artifact-engine_master-platforms:
          project-prefix: ovirt-live_master_build-artifacts-
          project-suffix: ""

      - copy-create-job-artifact:
          project: py2exe-py2.7_master_create-rpms-fc25-x86_64_merged
      - copy-create-job-artifact:
          project: pywin32-py2.7_master_create-rpms-fc25-x86_64_merged
      - copy-create-job-artifact:
          project: python-windows_master_create-rpms-fc25-x86_64_merged
      - copy-create-job-artifact:
          project: vcredist-x86_master_create-rpms-fc25-x86_64_merged
      - copy-create-job-artifact:
          project: nsis-simple-service-plugin_master_create-rpms-fc25-x86_64_merged
      - copy-create-job-artifact:
          project: ovirt-wgt_master_create-rpms-fc25-x86_64_merged

      - copy-create-job-artifact-vdsm-master-platforms:
          project-prefix: cockpit-ovirt_master_build-artifacts-
          project-suffix: ""
      - copy-create-job-artifact-vdsm-master-platforms:
          project-prefix: ovirt-engine-nodejs_master_build-artifacts-
          project-suffix: ""
      - copy-create-job-artifact-vdsm-master-platforms:
          project-prefix: ovirt-engine-nodejs-modules_master_build-artifacts-
          project-suffix: ""


      - copy-create-job-artifact-engine_master-platforms:
          project-prefix: ovirt-engine-sdk-ruby_master_build-artifacts-
          project-suffix: ""
      - copy-create-job-artifact-engine-master-ppc64le-platforms:
          project-prefix: ovirt-engine-sdk-ruby_master_build-artifacts-
          project-suffix: ""

      - copy-create-job-artifact-engine_master-platforms:
          project-prefix: ovirt-release_master_build-artifacts-
          project-suffix: ""

      - copy-create-job-artifact:
          project: imgbased_master_build-artifacts-el7-x86_64
      - copy-create-job-artifact:
          project: ovirt-node-ng_master_build-artifacts-el7-x86_64

      - copy-create-job-artifact:
          project: ovirt-guest-agent_master_build-artifacts-el6-x86_64
      - copy-create-job-artifact:
          project: ovirt-guest-agent_master_build-artifacts-el7-x86_64
      - copy-create-job-artifact:
          project: ovirt-guest-agent_master_build-artifacts-fc25-x86_64

      - copy-create-job-artifact-vdsm-master-platforms:
          project-prefix: ovirt-provider-ovn_master_build-artifacts-
          project-suffix: ""

      - copy-create-job-artifact-engine_master-platforms:
          project-prefix: ovirt-engine-metrics_master_build-artifacts-
          project-suffix: ""

    publishers:
      # We're not using the publish-rpms-nightly-publishers macro here because
      # code here is different (has the new 'sync from tested' functionality).
      # We expect the syncing from tested will simplify the publisher jobs over
      # time to the point where they all can use the same simple job template as
      # opposed to separate YAML per job.
      # The publishers macros support and are needed just the older style
      # publisher jobs for the time being
      - ssh:
          site: resources.ovirt.org
          source: '**/*.rpm, **/*.tar.gz, **/*.iso **/*.exe'
          target: ovirt-master-snapshot.tmp
          command: |
            READY_WAIT_ATTEMPTS=50
            READY_WAIT_INTERVAL=60s

            /bin/repoman ovirt-master-snapshot.tmp \
              add /srv/resources/repos/ovirt/tested/master/rpm:latest:only-missing
            find ovirt-master-snapshot.tmp -depth \
              -type d -name repodata -print0 | \
              xargs -0 -r rm -rf
            find ovirt-master-snapshot.tmp \
              -type f -name '*.rpm' -print0 | \
              xargs -0 -r touch

            mkdir -p artifacts/ovirt-master-snapshot.tmp
            rm -rf artifacts/ovirt-master-snapshot.tmp/*
            mv ovirt-master-snapshot.tmp/* artifacts/ovirt-master-snapshot.tmp
            # Wait until the *.ready directory is not there (cron job is done)
            let attempt=0
            while [[ -d artifacts/ovirt-master-snapshot.ready ]]; do
              if ((attempt >= READY_WAIT_ATTEMPTS)); then
                echo "Timed out waiting for cron job to finish"
                exit 1
              fi
              let attempt++
              echo -n "Waiting for scan_for_artifacts.sh cron job to finish"
              echo " (attempt $attempt of $READY_WAIT_ATTEMPTS)"
              sleep $READY_WAIT_INTERVAL
            done
            mv  artifacts/ovirt-master-snapshot.tmp  artifacts/ovirt-master-snapshot.ready

            rm -rf ovirt-master-snapshot.tmp
      - publish-rpms-nightly-cleanup
      - publish-rpms-nightly-email
