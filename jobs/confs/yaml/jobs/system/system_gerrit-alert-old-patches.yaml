- job:
    name: system_gerrit-alert-old-patches
    node: master
    triggers:
        - timed: "@weekly"
    parameters:
        - bool:
            name: DRY_RUN
            default: false
            description: "Turn on dry-run mode. Default is false."
        - string:
            name: WARNING
            default: "120"
            description: "Age in days for warning limit."
        - string:
            name: ABANDON
            default: "220"
            description: "Age in days for abandoning limit."
        - string:
            name: TEST_EMAIL
            default: ""
            description: "Optional email address to use with dry-run. Default is None."

    builders:
        - shell: |
            #!/bin/bash
            #TODO: add all ovirt projects
            user="jenkins_ro"
            projects="vdsm,ovirt-engine,jenkins,infra-puppet,lago,gerrit-admin,infra-docs,repoman"
            dry=

            if [ "$DRY_RUN" == 'true' ] ; then
                    dry="--dry-run"
            fi

            if [ -z "$TEST_EMAIL" ]; then
                $WORKSPACE/jenkins/scripts/alert_old_patches.py --user "$user" --warning-days-limit "$WARNING" --abandon-days-limit "$ABANDON" --debug --projects "$projects" $dry
            else
                $WORKSPACE/jenkins/scripts/alert_old_patches.py --user "$user" --warning-days-limit "$WARNING" --abandon-days-limit "$ABANDON" --debug --projects "$projects" --with-email "$TEST_EMAIL" $dry
            fi


    wrappers:
        - ssh-agent-credentials:
            users:
                - '106ec229-f1a1-4a0b-ac4f-38395556b6ad'
    scm:
        - jenkins:
            branch: master
            git-server: 'gerrit.ovirt.org'

    publishers:
        - email-ext:
            recipients: dcaro@redhat.com, eedri@redhat.com, ykaul@redhat.com, vishnu.srkmr@gmail.com
            content-type: text
            subject: Alert-Old-Patches Build ${BUILD_NUMBER}
            attach-build-log: true
            send-to:
                - recipients
