- job-template: &basic_system_tests
    name: '{project}_{version}_system-tests_{flavor}'
    node: '{node-filter}'
    parameters:
      - gerrit-params:
          branch: '{branch}'
    triggers:
      - timed: 'H 2 * * *'
    scm:
      - 'ovirt-system-tests-gerrit':
          branch: 'master'
          git-server: '{git-server}'
      - 'jenkins':
          branch: 'master'
          git-server: '{git-server}'
    builders:
      - cleanup-slave
      - 'system-tests':
          version: '{version}'
          suite_type : basic
          chroot_distro: '{chroot_distro}'
    publishers:
      - post-tasks:
          - matches:
              - log-text: '.*'
                operator: AND
            escalate-status: true
            script: !include-raw: shell-scripts/system_tests.collect_logs.sh
          - matches:
              - log-text: '.*'
                operator: AND
                escalate-status: true
            script: !include-raw-escape: shell-scripts/mock_cleanup.sh
      - junit:
          results: 'exported-artifacts/nosetests*.xml'
      - archive:
          artifacts: 'exported-artifacts/**'
          allow-empty: true
      - email:
          recipients: '{email-to}'
          notify-every-unstable-build: false
          send-to-individuals: false

- job-template:
    <<: *basic_system_tests
    name: '{project}_{version}_system-tests_manual'
    parameters:
      - custom-repos-param
      - gerrit-params:
          branch: '{branch}'
    triggers:
      - 'trigger_{trigger}':
          project: '{project}'
          branch: '{branch}'
    publishers:
      - post-tasks:
          - matches:
              - log-text: '.*'
                operator: AND
            escalate-status: true
            script: !include-raw: shell-scripts/system_tests.collect_logs.sh
          - matches:
              - log-text: '.*'
                operator: AND
                escalate-status: true
            script: !include-raw-escape: shell-scripts/mock_cleanup.sh
      - junit:
          results: 'exported-artifacts/nosetests*.xml'
      - archive:
          artifacts: 'exported-artifacts/**'
          allow-empty: true
      - email-ext:
          always: true
          send-to:
            - requester

- job-template:
    <<: *basic_system_tests
    name: '{project}_{version}_he-system-tests'
    builders:
      - cleanup-slave
      - 'system-tests':
          version: '{version}'
          suite_type : he_basic
          chroot_distro: '{chroot_distro}'

- job-template:
    <<: *basic_system_tests
    name: '{project}_{version}_image-ng-system-tests'
    triggers:
      - timed: "@midnight"
    builders:
      - shell: "rm -rf $WORKSPACE/ovirt-system-tests/images || true"
      - copyartifact:
          project: 'ovirt-appliance_ovirt-{version}_build-artifacts-el7-x86_64'
          which-build: upstream-build
          fallback-to-last-successful: true
          filter: "exported-artifacts/*.ova"
          optional: true
          target: ovirt-system-tests/images
      - copyartifact:
          project: 'ovirt-node-ng_ovirt-{version}_build-artifacts-el7-x86_64'
          which-build: upstream-build
          fallback-to-last-successful: true
          optional: true
          target: ovirt-system-tests/images
          filter: "exported-artifacts/*.squashfs.img"
      - cleanup-slave
      - 'system-tests':
          version: '{version}'
          suite_type : image_ng
          chroot_distro: '{chroot_distro}'
