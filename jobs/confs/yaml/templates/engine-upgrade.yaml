#
# Parameters:
#
# branch
#   Full name of the branch to upgrade to, for example ovirt-3.5
#
# version
#   Version tag of the job, as 3.5, 3.4, master...
#
# test-version
#   Version tag to upgrade from
#
# trigger
#   Type of trigger event, should be  merged (to trigger on patchset merged)
#

- job-template:
    name: 'ovirt-engine_{version}_upgrade-from-{test-version}_{distro}_{trigger}'
    properties:
      - throttle:
          enabled: true
          max-per-node: 1
          max-total: 6
          option: project
      - build-discarder:
          num-to-keep: 120
          artifact-num-to-keep: 20
    concurrent: true
    parameters:
      - gerrit-params:
          branch: '{branch}'
      - string:
          name: REPOS_FROM
          default: '{repos-from}'
          description: 'Comma separated list of urls for repos to use
              when installing engine for the first time'
      - string:
          name: REPOS_TO
          default: '{repos-to}'
          description: 'Comma sepparated list of extra repos to use when
              upgrading after the first engine setup (appart from the one
              that will be created with the generated rpms)'
    scm:
      - gerrit:
          project: 'ovirt-engine'
          git-server: '{git-server}'
      - jenkins:
          branch: 'master'
          git-server: '{git-server}'
    jdk: '{java-jdk}'
    node: '{distro}'
    triggers:
      - on-patch-{trigger}:
          project: '{project}'
          branch: '{branch}'
    wrappers:
      - copy-to-slave:
          includes:
            - 'artifactory-ovirt-org-settings.xml'
          relative-to: 'userContent'
    builders:
      - fix_rpmdb_problems
      - ovirt-engine_upgrade-engine:
          version: '{version}'
          test-version: '{test-version}'
    publishers:
      - engine-upgrade-cleanup:
          version: '{version}'
          test-version: '{test-version}'
      - archive:
          artifacts: 'logs/*'
          allow-empty: true
